---
// BackgroundCarousel 组件 - 背景轮播
const bgImages = [
  '/gallery/gallery_1.webp',
  '/gallery/gallery_16.jpg',
  '/gallery/gallery_31.webp',
  '/gallery/gallery_116.jpg',
  '/gallery/gallery_121.jpg',
  '/gallery/gallery_126.jpg',
  '/gallery/gallery_131.jpg',
  '/gallery/gallery_136.jpg',
  '/gallery/gallery_141.jpg',
  '/gallery/gallery_146.jpg',
  '/gallery/gallery_151.jpg',
  '/gallery/gallery_166.png',
  '/gallery/gallery_176.jpg',
  '/gallery/gallery_186.png',
  '/gallery/gallery_191.jpg',
];
---

<div id="siteBg" class="site-bg" aria-label="背景轮播">
  <div
    id="bgSwiper"
    class="swiper bg-swiper"
    aria-hidden="true"
    data-images={JSON.stringify(bgImages)}
  >
    <div class="swiper-wrapper">
      {bgImages.map((src) => (
        <div class="swiper-slide bg-image" style={`background-image: url(${src})`}></div>
      ))}
    </div>
  </div>
</div>

<button id="bgPrev" class="bg-btn bg-btn-left" type="button" aria-label="上一张">‹</button>
<button id="bgNext" class="bg-btn bg-btn-right" type="button" aria-label="下一张">›</button>
<div id="bgControls" class="bg-controls" role="group" aria-label="背景切换">
  <span id="bgIndex" class="bg-index">1/1</span>
</div>

<script>
  import Swiper from 'swiper';
  import { Autoplay } from 'swiper/modules';

  const bgSwiperEl = document.getElementById('bgSwiper');
  const bgIndexEl = document.getElementById('bgIndex');
  const bgControlsEl = document.getElementById('bgControls');
  const prevBtn = document.getElementById('bgPrev');
  const nextBtn = document.getElementById('bgNext');

  const bgImages = bgSwiperEl?.getAttribute('data-images')
    ? JSON.parse(bgSwiperEl.getAttribute('data-images') || '[]')
    : [];

  let currentIndex = parseInt(localStorage.getItem('bgIndex') || '0', 10);
  if (Number.isNaN(currentIndex) || currentIndex < 0) currentIndex = 0;
  if (currentIndex >= bgImages.length) currentIndex = 0;

  function getBgMode() {
    return document.documentElement.getAttribute('data-bg-mode') || 'solid';
  }

  function updateIndex(index: number) {
    currentIndex = index;
    if (bgIndexEl) bgIndexEl.textContent = `${currentIndex + 1}/${bgImages.length}`;
    localStorage.setItem('bgIndex', currentIndex.toString());
  }

  function updateBgControlsVisibility(swiper: import('swiper').Swiper) {
    if (!bgControlsEl || !prevBtn || !nextBtn) return;
    const isTransparent = getBgMode() === 'transparent';
    const hasMultiple = bgImages.length > 1;

    const shouldShow = isTransparent && hasMultiple;
    bgControlsEl.style.display = shouldShow ? 'flex' : 'none';
    prevBtn.style.display = shouldShow ? 'block' : 'none';
    nextBtn.style.display = shouldShow ? 'block' : 'none';

    if (shouldShow) {
      swiper.autoplay?.start();
    } else {
      swiper.autoplay?.stop();
    }
  }

  if (bgSwiperEl && bgImages.length > 0) {
    const swiper = new Swiper(bgSwiperEl, {
      modules: [Autoplay],
      effect: 'slide',
      speed: 1200,
      loop: true,
      allowTouchMove: false,
      initialSlide: currentIndex,
      autoplay: {
        delay: 9000,
        disableOnInteraction: false,
        pauseOnMouseEnter: false,
      },
      on: {
        init(swiper) {
          updateIndex(swiper.realIndex);
          updateBgControlsVisibility(swiper);
        },
        slideChange(swiper) {
          updateIndex(swiper.realIndex);
        },
      },
    });

    prevBtn?.addEventListener('click', () => {
      swiper.slidePrev();
      swiper.autoplay?.start();
    });

    nextBtn?.addEventListener('click', () => {
      swiper.slideNext();
      swiper.autoplay?.start();
    });

    window.addEventListener('bg-mode-change', () => {
      updateBgControlsVisibility(swiper);
    });
  }
</script>
